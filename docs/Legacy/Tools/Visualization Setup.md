
> [!WARNING] This note was automatically generated by AI based on daily notes, inaccuracies may exist.

> [!INFO] Link for C3D Viewer
> https://colab.research.google.com/drive/1p2qF3RPOm6TWYITeaeSh7hSq2z3PtQTF?usp=sharing

>[!info|right]
> **Part of a series on**
> ###### [[Dataset Overview|Van Criekinge]]
> ---
> **Solutions**
> * [[3 Solutions/New Marker Fitting|New Marker Fitting]]
> * [[3 Solutions/Old Fitting Code Explanation|Old Fitting Code]]
> * [[Tools/Visualization Setup|Visualization Setup]]

>[!info]
> ###### Visualization Setup
> [Type::Tool Guide]
> [Tool::colabC3D + ezc3d]
> [Environment::Google Colab]
> [Status::Active]

This document outlines the required setup and patches for using `colabC3D` and `ezc3d` to visualize Van Criekinge C3D data, particularly in Google Colab environments.


## Environment Setup
Run the following in the initial block of your Colab notebook:

```python
!pip install ezc3d
```

## Critical Patches

### 1. Fixing the `IndexError`
To resolve `IndexError: invalid index to scalar variable` when reading files with `Ezc3d`, add this block before the `# just for pygwalker` section:

```python
# Flatten the corners data for the 3D viewer
for fp_corners in corners:
    for i in range(4):
        ezced_corners.append(fp_corners[0][i])
        ezced_corners.append(fp_corners[1][i])
        ezced_corners.append(fp_corners[2][i])
```

### 2. Handling Coordinate Systems (Y-Up vs Z-Up)
The following patch ensures that the 3D viewer correctly processes playback for both standard and Y-Up coordinate systems. Replaces the point data ingestion loops:

```python
# Handle Y-Up and Z-Up for C3Dtools
if Number_of_actual_Marker > 0:
    for i in range(NumFrames):
        point_data = []
        for j in range(Number_of_actual_Marker):
            if (Y_SCREEN == '-Z' or Y_SCREEN == '+Z'):
                point_data.append(points[i, j, 0])
                point_data.append(points[i, j, 2])
                point_data.append(points[i, j, 1] * -1)
            else: # Handle Y-Up
                point_data.append(points[i, j, 0])
                point_data.append(points[i, j, 1])
                point_data.append(points[i, j, 2])
        main_point_data.append(point_data)
```

## 3D Viewer Script
Use this block to initialize the 3D viewer and avoid file path errors:

```python
#@title 3D Viewer
import os
file_path = "Viewer3D.html"
if not os.path.isfile(file_path):
  !wget https://raw.githubusercontent.com/etoshey/colabC3D/main/Viewer3D.html

with open(file_path, 'r') as file:
    html_content = file.read()

from IPython.display import HTML
HTML(html_content)
```

## Utility: Merging C3D Files
If trials are split into multiple sequential files (e.g., `SUBJ1 (0).c3d`, `SUBJ1 (1).c3d`), use the following `ezc3d` script to concatenate them:

```python
import ezc3d
import numpy as np

file_list = ["trial_0.c3d", "trial_1.c3d", "trial_2.c3d"]
c3d_objects = [ezc3d.c3d(f) for f in file_list]

concatenated_points = np.concatenate([c['data']['points'] for c in c3d_objects], axis=2)
concatenated_analogs = np.concatenate([c['data']['analogs'] for c in c3d_objects], axis=2)

c_new = ezc3d.c3d()
c_new['parameters'] = c3d_objects[0]['parameters']
c_new['data']['points'] = concatenated_points
c_new['data']['analogs'] = concatenated_analogs
c_new.write("concatenated_trial.c3d")
```
